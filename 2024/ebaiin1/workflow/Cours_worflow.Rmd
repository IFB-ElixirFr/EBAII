---
title: "EB3I : Cours Workflow"
author: "Rachel Legendre, Charlotte Berthelier, Gabriele Adam"
contributeurs: "Denis Puthier, Pierre Pericard, Claire Toffano-Nioche, Maria Bernard"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  rmdformats::material:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango

---



# Outline

**Objectif :** 

Lancer le m√™me outil (fastqc) sur 3 √©chantillons diff√©rents

**Concepts :**

- √âcriture d‚Äôun script bash

- D√©claration de variables pour g√©n√©raliser les √©chantillons et les r√©pertoires de travail

- R√©alisation d‚Äôune boucle pour lancer l‚Äôoutil sur chaque √©chantillon

- Premier script SLURM


## D√©marrage d‚Äôune instance sur Jupyter

**Objectif :** lancer le m√™me outil (FastQC) sur 3 √©chantillons Fastq diff√©rents 

<div style="text-align: center;">
  ![](images/jupyter.png)
</div>

<div style="text-align: center;">
  2538_eb3i_n1_2025, 4 CPUs, 2 Go RAM
</div>




# Variables et scripts

**D√©finition:** ce sont des √©l√©ments qui associent un nom (l'identifiant) √† une valeur, qui sera sauvegard√©e dans la m√©moire du syst√®me programm√©. 

- Il existe un certain nombre de variables syst√®mes pr√©-d√©finies


```{bash, eval=FALSE}
echo $USER
echo $PWD
echo $SHELL

env | head # Liste les variables syst√®me
```


-   On peut cr√©er ses propres variables
-   Il faudra pr√©fixer les variables avec le caract√®re ‚Äò\$‚Äô pour y faire
    r√©f√©rence

```{bash, eval=FALSE}
PROJECT=project_rlegendre # Attention, pas d‚Äôespace autour de l‚Äôop√©rateur "="
echo ${PROJECT} # ou echo $PROJECT 
echo /shared/projects/${PROJECT}

WORKDIR=/shared/projects/${PROJECT}
echo ${WORKDIR}
```

## Pr√©paration de l‚Äôenvironnement de travail

```{bash, eval=FALSE}
mkdir -p ${WORKDIR}/tp_workflow/

cd ${WORKDIR}/tp_workflow/

mkdir data

cd data

wget https://zenodo.org/records/10081865/files/FILE1.fastq.gz
wget https://zenodo.org/records/10081865/files/FILE2.fastq.gz
wget https://zenodo.org/records/10081865/files/FILE3.fastq.gz

cd .. 

touch script_01.sh 
```

## Script simple

Dans un script_01.sh :

```{bash, eval=FALSE}
#!/bin/bash
mkdir -p fastqc
module load fastqc/0.11.9

fastqc --outdir fastqc data/FILE1.fastq.gz
fastqc --outdir fastqc data/FILE2.fastq.gz
fastqc --outdir fastqc data/FILE3.fastq.gz
```


### Lancement du workflow

Lancez votre workflow dans le terminal

```{bash, eval=FALSE}
bash script_01.sh
```

Si besoin: wget https://github.com/IFB-ElixirFr/EBAII/tree/master/2024/ebaiin1/workflow/scripts/script_01.sh

## Avec d√©finition de la variable SAMPLE

Dans un script_02.sh :

```{bash, eval=FALSE}
#!/bin/bash

mkdir -p fastqc
module load fastqc/0.11.9

SAMPLE=FILE1
echo ">>> Processing $SAMPLE"
fastqc --outdir fastqc data/${SAMPLE}.fastq.gz

SAMPLE=FILE2
echo ">>> Processing $SAMPLE"
fastqc --outdir fastqc data/${SAMPLE}.fastq.gz

SAMPLE=FILE3
echo ">>> Processing $SAMPLE"
fastqc --outdir fastqc data/${SAMPLE}.fastq.gz
```

### Lancement du workflow

Lancez votre workflow dans le terminal

```{bash, eval=FALSE}
bash script_02.sh
```


Si besoin: wget https://github.com/IFB-ElixirFr/EBAII/tree/master/2024/ebaiin1/workflow/scripts/script_02.sh


## On redirige les sorties 

Dans un script_03.sh :

```{bash, eval=FALSE}
#!/bin/bash

mkdir -p fastqc
module load fastqc/0.11.9

SAMPLE=FILE1
echo ">>> Processing $SAMPLE"
fastqc --outdir fastqc data/${SAMPLE}.fastq.gz 2> fastqc/${SAMPLE}.log

SAMPLE=FILE2
echo ">>> Processing $SAMPLE"
fastqc --outdir fastqc data/${SAMPLE}.fastq.gz 2> fastqc/${SAMPLE}.log

SAMPLE=FILE3
echo ">>> Processing $SAMPLE"
fastqc --outdir fastqc data/${SAMPLE}.fastq.gz 2> fastqc/${SAMPLE}.log
```


## Question bonus 

Comment rediriger le message  ‚ÄúAnalysis complete for FILE1.fastq.gz‚Äù ?


<details>
<summary>Cliquez ici pour voir tricher ! </summary>

Utiliser l‚Äôop√©rateur &> qui permet de rediriger STDIN (la sortie standard) et STDERR (la sortie d‚Äôerreur) dans un m√™me fichier

![](images/image_out.png)

</details>

### Lancement du workflow

Lancez votre workflow dans le terminal

```{bash, eval=FALSE}
bash script_03.sh
```


Si besoin: wget https://github.com/IFB-ElixirFr/EBAII/tree/master/2024/ebaiin1/workflow/scripts/script_03.sh

`
# Utilisation des boucles `for`

Une boucle permet de r√©aliser des t√¢ches it√©ratives. 

```{bash, eval=FALSE}
for PRENOM in Pauline Stephanie Emilie Pierre Mathieu
  do
    echo ${PRENOM}
  done
  
#On peut it√©rer sur une liste de fichiers
for FILE in data/*
  do
    echo ${FILE}
  done
  
#On peut it√©rer sur le r√©sultat d‚Äôune commande
for READ in $(ls data/* | grep -v FILE1)
  do
    echo ${READ}
  done
```


## It√©rer sur les fichiers Fastq

Dans un script_04.sh :

```{bash, eval=FALSE}
#!/bin/bash

mkdir -p fastqc
module load fastqc/0.11.9

for SAMPLE in FILE1 FILE2 FILE3
do
echo ">>> Processing $SAMPLE"
fastqc --outdir fastqc data/${SAMPLE}.fastq.gz &> fastqc/${SAMPLE}.log
done
```


### Lancement du workflow

Lancez votre workflow dans le terminal

```{bash, eval=FALSE}
bash script_04.sh
```

Si besoin: wget https://github.com/IFB-ElixirFr/EBAII/tree/master/2024/ebaiin1/workflow/scripts/script_04.sh


## It√©rer sur le r√©sultat d‚Äôune commande

Dans un script_05.sh :

```{bash, eval=FALSE}
#!/bin/bash

mkdir -p fastqc

module load fastqc/0.11.9

for SAMPLE in $(ls data/ | sed 's/.fastq.gz//')
do
echo ">>> Processing $SAMPLE"
fastqc --outdir fastqc data/${SAMPLE}.fastq.gz &> fastqc/${SAMPLE}.log
done
```

### Lancement du workflow

Lancez votre workflow dans le terminal

```{bash, eval=FALSE}
bash script_05.sh
```


Si besoin: wget https://github.com/IFB-ElixirFr/EBAII/tree/master/2024/ebaiin1/workflow/scripts/script_05.sh

## Ajouter des options pour SLURM


On commence √† d√©crire un peu plus pr√©cis√©ment les ressources n√©cessaires √† notre √©tape

```{bash, eval=FALSE}
#!/bin/bash

#SBATCH --account=$USER
#SBATCH --job-name=fastqc_test
#SBATCH --account=2538_eb3i_n1_2025  # Modifier en fonction du projet
#SBATCH --cpus-per-task=1        # Modifier en fonction des besoins
#SBATCH --mem=4GB                # Idem

module load ‚Ä¶
‚Ä¶
```

Plein d‚Äôautres options utiles: voir intro SLURM et https://ifb-elixirfr.gitlab.io/cluster/doc/quick-start/

Dans un script_06.sh : 

```{bash, eval=FALSE}
#!/bin/bash

#SBATCH --partition=fast
#SBATCH --job-name=my_fastqc
#SBATCH --account=2538_eb3i_n1_2025  # Modifier en fonction du projet
#SBATCH --cpus-per-task=1        # Modifier en fonction des besoins
#SBATCH --mem=4GB                # Idem
  
mkdir -p fastqc
module load fastqc/0.11.9

for SAMPLE in $(ls data/ | sed 's/.fastq.gz//')
do
echo ">>> Processing $SAMPLE"
srun --job-name $SAMPLE fastqc --outdir fastqc data/${SAMPLE}.fastq.gz
done
```


### Lancement du workflow

Lancez votre workflow dans le terminal

```{bash, eval=FALSE}
sbatch script_06.sh

```

Si besoin: wget https://github.com/IFB-ElixirFr/EBAII/tree/master/2024/ebaiin1/workflow/scripts/script_06.sh
Cette fois ci, on lance le script avec la commande sbatch et on monitore avec squeue


V√©rifier que le job tourne

```{bash, eval=FALSE}
squeue
squeue -u $USER

sacct -u $USER
sacct -u $USER | tail -n 1
```



# Parallelisation des taches 

Au lieu de lancer chaque job l‚Äôun apr√®s l‚Äôautre, de mani√®re s√©quentielle, on va les lancer en parall√®le. On utilise un ‚Äújob array‚Äù.


Dans un script_07.sh : 

```{bash, eval=FALSE}
#!/bin/bash
#SBATCH --partition=fast
#SBATCH --job-name=my_fastqc
#SBATCH --account=2538_eb3i_n1_2025  # Modifier en fonction du projet
#SBATCH --cpus-per-task=1        # Modifier en fonction des besoins
#SBATCH --mem=4GB                # Idem
#SBATCH --array=1-3              # Modifier en fonction du nb de t√¢ches √† lancer en parall√®le

mkdir -p fastqc
module load fastqc/0.11.9

# le Ni√®me fichier de ma liste
SAMPLE=$(ls data/ | sed 's/.fastq.gz//' | \
head -n ${SLURM_ARRAY_TASK_ID} | tail -n 1)

srun --job-name $SAMPLE fastqc --outdir fastqc data/${SAMPLE}.fastq.gz
```


## Lancement du workflow

Lancez votre workflow dans le terminal

```{bash, eval=FALSE}
sbatch script_07.sh
sacct -u $USER | grep RUNNING | grep FILE
```

Si besoin: wget https://github.com/IFB-ElixirFr/EBAII/tree/master/2024/ebaiin1/workflow/scripts/script_07.sh


# Ajouter une etape

Dans un script_08.sh :

```{bash, eval=FALSE}
#!/bin/bash
#SBATCH --partition=fast
#SBATCH --job-name=my_fastqc
#SBATCH --account=2538_eb3i_n1_2025 # Modifier en fonction du projet
#SBATCH --cpus-per-task=1       # Modifier en fonction des besoins
#SBATCH --mem=4GB               # Idem
#SBATCH --array=1-3             # Modifier en fonction du nb de t√¢ches √† lancer en parall√®le

mkdir -p fastqc
module load fastqc/0.11.9
mkdir -p trimmomatic
module load trimmomatic/0.39

# le Ni√®me fichier de ma liste
SAMPLE=$(ls data/ | sed 's/.fastq.gz//' | \
head -n ${SLURM_ARRAY_TASK_ID} | tail -n 1)

srun --job-name FASTQC-$SAMPLE fastqc --outdir fastqc data/${SAMPLE}.fastq.gz
srun --job-name TRIM-$SAMPLE trimmomatic SE -threads 4 -phred33 \
                            data/${SAMPLE}.fastq.gz  trimmomatic/${SAMPLE}.fastq.gz \
                            SLIDINGWINDOW:4:20 MINLEN:20
```


## Lancement du workflow

Lancez votre workflow dans le terminal

```{bash, eval=FALSE}
sbatch script_08.sh
sacct -u $USER | grep RUNNING | grep FILE
```


Si besoin: wget https://github.com/IFB-ElixirFr/EBAII/tree/master/2024/ebaiin1/workflow/scripts/script_08.sh


# üî¨ Workflow ChIP-seq


<img src="images/chip_pipeline.png" style="width: 100% !important; max-width: 100% !important; display: block; margin: auto;">



# üß¨ Workflow RNA-seq

<img src="images/rnaseq_pipeline.png" style="width: 100% !important; max-width: 100% !important; display: block; margin: auto;">

<img src="images/rnaseq_pipeline2.png" style="width: 100% !important; max-width: 100% !important; display: block; margin: auto;">

### Mise en pratique: Alignement avec STAR

On vous propose maintenant de mettre en pratique ce que vous venez de voir et d‚Äô√©crire
un script SLURM pour aligner tous les √©chantillons sur le g√©nome de r√©f√©rence avec STAR

```{bash, eval=FALSE}
$ module load star/2.7.9a
$ STAR --help
```

Si besoin de plus d'aide : [manuel STAR](https://github.com/alexdobin/STAR/blob/master/doc/STARmanual.pdf)

Index STAR: ```/shared/bank/arabidopsis_thaliana/TAIR10.1/star-2.7.9a/```

Annotation (GTF):
`/shared/bank/arabidopsis_thaliana/TAIR10.1/gtf/GCF_000001735.4_TAIR10.1_genomic.gtf`

### Script d'alignement avec STAR

On voudra lancer le script avec la commande sbatch :

```{bash, eval=FALSE}
sbatch star_align.sh
```

<details>
<summary>Cliquez <span style="color: green;">**ici**</span> pour voir la solution ! </summary>

```{bash, eval=FALSE}
#!/bin/bash

#SBATCH --account=2422_ebaii_n1
#SBATCH --job-name=star_align
#SBATCH --cpus-per-task=8
#SBATCH --mem=20GB
#SBATCH --array=1-6

module load star/2.7.11a

OUT_DIR="/path/to/my/project/TP_rnaseq/workflow/star_res"
mkdir -p $OUT_DIR

DATA_DIR="/shared/projects/2422_ebaii_n1/atelier_rnaseq/04-Workflow/data/"
STAR_INDEX="/shared/bank/arabidopsis_thaliana/TAIR10.1/star-2.7.9a/"
GTF="/shared/bank/arabidopsis_thaliana/TAIR10.1/gtf/GCF_000001735.4_TAIR10.1_genomic.gtf"

R1IN=$(ls $DATA_DIR/*_R1.fastq.gz | awk "NR==${SLURM_ARRAY_TASK_ID}")
R2IN=${R1IN/_R1/_R2}
BASENAME=${R1IN/_R1.fastq.gz/.STAR_TAIR10.1_}

srun STAR --runThreadN ${SLURM_CPUS_PER_TASK} --genomeDir ${STAR_INDEX} \
  --sjdbGTFfile ${GTF} --readFilesCommand zcat --readFilesIn ${R1IN} ${R2IN} \
  --outFileNamePrefix ${OUT_DIR}/${BASENAME} --outSAMtype BAM SortedByCoordinate \
  --outSAMunmapped Within KeepPairs
```

</details>



# üåø Workflow Variants

<img src="images/workflow_variant.png" style="width: 100% !important; max-width: 100% !important; display: block; margin: auto;">
