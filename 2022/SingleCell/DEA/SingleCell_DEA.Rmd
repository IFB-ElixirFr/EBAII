---
title: "Differential Expression Analysis"
date: "`r Sys.Date()`"
author:
  - name: "Thibault DAYRIS"
    email: "thibault.dayris@gustaveroussy.fr"
  - name: "Bastien JOB"
    email: "bastien.job@gustaveroussy.fr"
output:
  # html_document:  # Defautl view
  rmdformatsbigr::readthebigrdoc:  # if you'd like to have a nice theme
    code_folding: hide
    thumbnails: false
    lightbox: true
    highlight: true
    fig_caption: false
    
    
# install.packages("remotes")
# install.packages("git2r")
# remotes::install_git("https://gitlab.com/bioinfo_gustaveroussy/bigr/rmdformatsbigr.git",
#                      credentials=git2r::cred_user_pass("your_login", "your_password"))
---


```{r setup, include=FALSE}
# options(width = 60);
knitr::opts_chunk$set(
  echo = TRUE,        # Print the code
  eval = FALSE,       # Do not run command lines
  message = FALSE,    # Print messages
  prompt = FALSE,     # Do not display prompt
  comment = NA,       # No comments on this section
  warning = TRUE#,    # Display warnings
  
  # width = 100       # Number of characters per line
  
);

```

<style type="text/css">
details:hover { cursor: pointer }
</style>

<style>
.column-left{
  float: left;
  width: 47%;
  text-align: left;
}
.column-right{
  float: right;
  width: 47%;
  text-align: left;
}
</style>

![logos](images/logos.png)

# Forewords

In this presentation, there will be screen captures, for you to follow the lesson. There will also be R command lines (hidden by default). Do not take care of the command lines if you find them too challenging. Our goal here, is to understand the main mechanism of Differential Expression Analysis. R is just a tool.

```{r load_libraries, eval=TRUE}
library(package = "knitr")
library(package = "dplyr")
library(package = "singleCellTK")
library(package = "Seurat")
library(package = "ggplot2")
library(package = "ggpubr")
library(package = "rstatix")
```

## Load RDS dataset

```{r import_dataset, eval=TRUE, cache=TRUE}
integrated_sctk <- readRDS(file = "dataset/INTEGRATED_02d_ClustLab.rds")
```

In SingleCellTK, click "Data".

1. Import SingleCellExperiment or Seurat object stored in an RDS file
1. click "Browse" and select INTEGRATED_02d_ClustLab.rds
1. click "Add To Sample List"
1. click "Import"
1. wait ...
1. Set "Rownames (Default)" as "Feature for Display"

This may be a bit long, depending on the size of the input dataset.

## Insight

Have a look at your dataset. The Shiny interface returns the following description:

![singlecelltk_input](images/DataSummary.png)

Aside, we might want to look at this dataset through R, using the function [`head`](https://www.rdocumentation.org/packages/utils/versions/3.6.2/topics/head).

```{r display_summary_of_integrated_counts, eval=TRUE}
head(integrated_sctk)
```

We can see the name of the normalized dataset and raw counts, we read the name of the dimension reduction steps, we can see the number of cells (7311) and the list of available metadata (8). This information is quite precious when you recieve an unknown dataset, but here, we know where these data come from.


# Hands on a single gene

Question is now to guess wether a gene is differnetially expressed or not.


## Case of the gene Jund

Let's have a look at the gene named ['Jund'](https://www.genecards.org/cgi-bin/carddisp.pl?gene=jund), involved in senescence and apoptosis.

```{r expression_of_jund_violinplot, eval=TRUE}
singleCellTK::plotSCEViolin(
  inSCE=integrated_sctk, 
  feature="Jund", 
  slotName="assays", 
  itemName="SLNst", 
  groupBy="sample", 
  ylab="Expression", 
  xlab="Sample", 
  defaultTheme=FALSE,
  title="Expression of Jund in both conditions"
)
```

Using 'intuition', is that gene differentially expressed ?

I can give you expression density for that gene if it helps:

```{r expression_density_of_jund_violinplot, eval=TRUE}
singleCellTK::plotSCEDensity(
  inSCE=integrated_sctk, 
  feature="Jund", 
  slotName="assays", 
  itemName="SLNst", 
  groupBy="sample", 
  ylab="Expression", 
  xlab="Sample", 
  defaultTheme=FALSE, 
  title="Expression density of Jund in both conditions"
)
```

Okay, let's have some informations about these distributions.

<div class="column-left">
Within the G3 group:

```{r Jund_summaries_G3, eval=TRUE}
countsG3 <- as.data.frame(
  SummarizedExperiment::assay(x=integrated_sctk, i="SLNst")
) %>% select( matches("^G3."))

JundG3 <- as.data.frame(t(countsG3["Jund", ]))
JundG3$Group <- "G3"

summary(JundG3)
```
</div>
<div class="column-right">
Withing the G4 group:

```{r Jund_summaries_G4, eval=TRUE}
countsG4 <- as.data.frame(
  SummarizedExperiment::assay(x=integrated_sctk, i="SLNst")
) %>% select( matches("^G4."))

JundG4 <- as.data.frame(t(countsG4["Jund", ]))
JundG4$Group <- "G4"

summary(JundG4)
```
</div>

## From biology to statistics

Okay, let us resort on statistics to evaluate our chances to be guess correctly.

We have lots of observations: 3 468 cells in G3 group, and 3 843 cells in G4 groups. Statisticians really like to have a lot of observations! Ideally, statisticians always want to have more observation than tests. We have a total of `r 3468 + 3843` observations and we are testing 1 gene. For them, this is a dream come true!

Our cells are supposed to be interactig with each others ? Are they independent from each others ? This is very important, and usually, it requires a discussion.

Does the expression in our cells follow a normal distribution ? It's easy to check. Let's draw the expression like we did above:

```{r distribution_Jund, eval=TRUE}
Jund <- rbind(JundG3, JundG4)
gghistogram(Jund, x="Jund", y = "..density..", fill = "steelblue", bins=15, add_density=TRUE)
```

Our distribution seems to be binomial we will have to rely on non-parametric tests.

Let's run a non-parametric test base on the mean of distributions, since it's the clothest to our 'intuitive' approach. Let there be [Wilcoxon](https://en.wikipedia.org/wiki/Wilcoxon_signed-rank_test) test.

In R, it's quite straightforward: we have the function [`wilcoxon_test`](https://www.rdocumentation.org/packages/rstatix/versions/0.7.1) to perform the test, then we can plot the result.

```{r wilcoxon_jund, eval = TRUE}
stat.test <- Jund %>% wilcox_test(Jund ~ Group) %>% add_significance()
eff.size <- Jund %>% wilcox_effsize(Jund ~ Group)
```

```{r display_wilcoxon_jund_result, echo = FALSE, eval = TRUE, results = "asis"}
kable(stat.test, caption = "Wilcoxon test result")
```

And graphically, we have:

```{r boxplots_manual, eval = TRUE}
singleCellTK::plotSCEViolin(
  inSCE=integrated_sctk, 
  feature="Jund", 
  slotName="assays", 
  itemName="SLNst", 
  groupBy="sample", 
  ylab="Expression", 
  xlab="Sample", 
  defaultTheme=FALSE,
  title="Expression of Jund in both conditions"
) + stat_pvalue_manual(
  stat.test, tip.length = 0
) + labs(
  subtitle = get_test_label(stat.test, detailed = TRUE)
)
```